---
title: "Group 2 Project Report"
format: html
editor: visual
author: Danni Cox, Sophia Hemsi, Sarah Mulligan, 
---

## 1.1 Use a discrete density-dependent and -independent population model to assess the population growth dynamics of any three species within the 10 most abundant species.

```{r}

library('tidyverse')
library('tidyr')
library('dplyr')
library('DescTools')
library('vegan')
library('ggplot2')
library('lubridate')
library('ecotraj')

data <- read_csv('~/AdvancedEcologyWorkshop/group2.csv')

# Identify top 3 species

species_abundance <- data |>
  group_by(species) |>
  summarise(total_abundance = sum(n, na.rm = T)) |>
  arrange(desc(total_abundance)) |>
  slice(1:10)

top3species <- species_abundance$species[1:3]

top3species

data$lambda = NA

# top 3 species over time

data_over_time <- data |>
  filter(species %in% top3species) |>
  group_by(species, date) |>
  summarise(N = sum(n, na.rm = T)) |>
  arrange(species, date) |>
  ungroup()

ggplot(data_over_time, aes(x = date, y = N, color = species)) +
  geom_point() +
  geom_line() +
  labs(title = "Abundance of Top 3 Species Over Time",
       x = "Date",
       y = "Abundance",
       color = "Species") +
  theme_bw()
```

```{r}

# density independent model

data_w_lambda <- data_over_time |>
 arrange(species, date) |>
   mutate(lambda = lead(N)/N)

avg_lambda <- data_w_lambda |>
  group_by(species) |>
  summarise(
    mean_lambda = Gmean(lambda, na.rm = T),
    mean_sd = Gsd(lambda, na.rm = T)
  )

avg_lambda

# lambda over time

ggplot(data_w_lambda |> filter(!is.na(lambda)),
       aes(x = date, y = lambda, color = species)) +
  geom_point() +
  geom_line() +
  labs(title = "Lambda Over Time", x = "Date", y = "Lambda", color = "Species") +
  theme_bw()

trends <- avg_lambda |>
  mutate(pop_trends = case_when(
    mean_lambda > 1.0 ~ "Growing",
    mean_lambda == 1.0 ~ "Satble",
    mean_lambda < 1.0 ~ "Declining"
  ))

trends


```

```{r}

# project the population - density independent model

years <- 2000

pop <- data_w_lambda |>
  group_by(species) |>
  slice_max(date, n = 1) |>
  select(species, N_0 = N, t_0 = date) |>
  left_join(avg_lambda, by = "species")

sim <- tibble()

for(i in 1:nrow(pop)) {
  Species <- pop$species[i]
  N0 <- pop$N_0[i]
  lambda <- pop$mean_lambda[i]
  t0 <- as.Date(pop$t_0[i])   # <-- FIXED
  
  N <- numeric(years + 1)
  N[1] <- N0
  
  for(t in 1:years) {
    N[t + 1] <- lambda * N[t]
  }
  
  projected_pop <- tibble(
    species = Species,
    year = 0:years,
    projection = N,
    t_i = t0 + years(0:years)  # works now
  )
  
  sim <- bind_rows(sim, projected_pop)
}

sim

ggplot(sim, aes(x = year, y = projection, color = species)) +
  geom_line() +
  labs(title = "Abundance of Top 3 Species Using a\nDensity-Independent Population Model",
       x = "Years", y = "Projected Abundance", color = "Species") +
  theme_bw()
```

```{r}

# density-dependent model

years <- 10000

pop2 <- data_w_lambda |>
  group_by(species) |>
  slice_max(date, n = 1) |>
  select(species, N_0 = N, t_0 = date) |>
  left_join(avg_lambda, by = "species") |>
  mutate(rd = mean_lambda - 1)

K_estimate <- data_over_time |>
  group_by(species) |>
    summarise(K = max(N, na.rm = T))


pop2 <- pop2 |>
  left_join(K_estimate, by = "species")

sim2 <- tibble()

for(i in 1:nrow(pop2)) {
  Species <- pop2$species[i]
  N0 <- pop2$N_0[i]
  rd <- pop2$rd[i]
  K <- pop2$K[i]
  t0 <- as.Date(pop2$t_0[i])   # <-- FIXED
  
  N <- numeric(years + 1)
  N[1] <- N0
  
  for(t in 1:years) {
    N[t + 1] <- N[t] + rd * N[t] * (1 - N[t] / K)
    
    if (N[t + 1] < 0) {
      N[t + 1] <- 0
    }
  }

  projected_pop2 <- tibble(
    species = Species,
    year = 0:years,
    projection = N,
    t_i = t0 + years(0:years),   # works now
    K = K,
    rd = rd
  )
  
  sim2 <- bind_rows(sim2, projected_pop2)
}

sim2

ggplot(sim2, aes(x = year, y = projection, color = species)) +
  geom_line() +
  geom_hline(data = sim2 |> distinct(species, K),
             aes(yintercept = K, color = species),
             linetype = "dashed", linewidth = 1) +
  labs(title = "Abundance of Top 3 Species Using\na Density-Dependent Population Model",
    x = "Years",
    y = "Projected Abundance",
    color = "Species"
  ) +
  theme_bw()
```

## What can you infer from both models (Modeli \| Speciesi)? For each species, what is the most proper model to assess their growth? Why?

(answer)

## 1.2 Based on the selected models, how does lambda change over time?

(answer)

## 2.1 Does the sampling assigned to your group reach the asymptote of the species accumulation curve? Discuss results.

```{r}
Rare <- data |> 
  group_by(date) |> 
  ungroup()
sp_rare  <- unique(Rare$species)
yr_rare <- unique(data$date)
sp_rare_tib = tibble(n_samp = 1:length(yr_rare), n_spp = NA)
for (i in 1:length(yr_rare)){
  # sample ID to include
  samp = yr_rare[1:i]
  # include only sample numbers 
  d = data |> 
    filter(date %in% samp,
           n > 0)
  sp_rare_tib$n_spp[i] = length(unique(d$species))
}
ggplot(sp_rare_tib, aes(n_samp, n_spp))+
  geom_line(linewidth = 1)+
  labs(x = 'Number of Samples',
       y = 'Number of Species')+
  theme_bw()
```

(Answer)

## 2.2 Using the species that composed 75% of the abundance of species within the nektonic community, assess the annual trends of alpha and beta diversity, and the inverse Simpson diversity index.

```{r}
data2 <- data |>
  group_by(species) |>
  summarise(sum(n))
sum(data2$`sum(n)`)
16745*0.75
sp75 <- c('Black Drum', 'Red Drum', 'Atlantic Croaker', 'Blue Crab', 'Striped Mullet')
data <- data %>%
  mutate(date = mdy(date))
data <- data %>%
  mutate(year = year(date))
annual_abundance <- data %>%
  group_by(species, year) %>%
  summarise(total_abundance = sum(n, na.rm = TRUE), .groups = "drop")
annual_abundance <- annual_abundance |>
  filter(species %in% sp75)

df = unique(annual_abundance[c("year")])
df$H = NA
annual_abundance <- annual_abundance %>%
  rename(abundance = total_abundance)
for (i in 1:nrow(df)){
  d = annual_abundance |> filter(year == df$year[i])
  d = d |> 
    count(species,wt = abundance) |> 
    mutate(pi = n/sum(n),
           ln_pi = log(pi),
           p_ln_pi = pi*ln_pi)
  
  df$H[i] = -sum(d$p_ln_pi)
}
df |>
  summarise(mean_H = mean(H, na.rm = TRUE),
            sd_H = sd(H, na.rm = TRUE))
ggplot(df, aes(year, H)) +
  geom_line(linewidth = 1)+ 
  geom_point() +
  labs(x = 'Date',
       y = 'Shannon Diversity')+
  theme_bw()

df$d <- NA
for (i in 1:nrow(df)){
  d = annual_abundance |> filter(year == df$year[i])
  d = d |> count(species,wt = abundance) |> 
    mutate(pi = n/sum(n))
  
  df$d[i] = sum(d$pi^2)
}

df$even <- NA
df$inv <- NA
for(i in 1:nrow(df)){
df$even[i] = 1 - df$d[i]
df$inv[i] = 1/df$d[i]}

ggplot(df, aes(year, d)) +
  geom_line(linewidth = 1)+ 
  geom_point() +
  labs(x = 'Date',
       y = 'Simpson Diversity')+
  theme_bw()

ggplot(df, aes(year, inv)) +
  geom_line(linewidth = 1)+ 
  geom_point() +
  labs(x = 'Date',
       y = 'Inverse Simpson Diversity')+
  theme_bw()

mean(df$inv)

data_w <- data |>
  group_by(year, species) |>            
  summarise(total_n = sum(n), .groups="drop") |>
  pivot_wider(names_from = species, values_from = total_n, values_fill = 0)
comm <- data_w |> 
  summarise(across(`Black Drum`:`White Shrimp`, mean))

jacdist <- vegdist(data_w, method = "jaccard")
nmds.jc <- metaMDS(data_w, distance = "jaccard", k = 2, try = 100)
nmds.jc
braydist = vegdist(data_w, method = "bray")
braydist
nmds.bc = metaMDS(data_w, distance = "bray", k = 2, try = 100)
nmds_output = bind_rows(bc = data.frame(nmds.bc[["points"]]),
                        jc = data.frame(nmds.jc[["points"]])) |> 
  mutate(year = rep(unique(data_w$year), times = 2),
         Dissimilarity = rep(c("Bray", "Jaccard"),
                             each = length(unique(year))))

ggplot(nmds_output, aes(MDS1, MDS2, color = as.factor(year)))+
  geom_point(size = 4)+ 
  facet_wrap(~Dissimilarity)+
  labs(color = 'year')+
  scale_color_viridis_d(option = 'turbo')+
  theme_bw()
```

## 2.2 Using a community trajectory analysis, assess the annual stability of the fish community across the sites from the assigned basin and gear type. Describe and discuss the main results.

```{r}
data$site <- as.integer(factor(data$lat))
data_w2 <- data |>
  pivot_wider(names_from = species,
    values_from = n,
    values_fill = 0)
comm_matrix <- data_w2 |> select(-year, -basin, -date, -lat, -lon, -gear, -sci_name, -site)
site <- data$site
survey = data$year
b_dist <- vegdist(comm_matrix, method = "bray", na.rm = TRUE)
d <- defineTrajectories(b_dist, sites = site, surveys = survey)
trajectoryPCoA(d,
  traj.colors = c("black","red", "blue", 'lightblue3', 'purple', 'pink'),
  lwd = 3,
  survey.labels = FALSE)
legend("bottomleft", col=c("black","red", "blue", 'lightblue3', 'purple', 'pink'), 
       legend=unique(data$site), bty="n", lty=1, lwd = 2)
```

(Answer)
