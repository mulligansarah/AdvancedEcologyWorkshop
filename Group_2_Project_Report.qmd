---
title: "Group 2 Project Report"
format: pdf
editor: visual
author: Danni Cox, Sophia Hemsi, Sarah Mulligan
---

## 1.1a Use a discrete density-dependent and -independent population model to assess the population growth dynamics of any three species within the 10 most abundant species.

```{r}

library('tidyverse')
library('tidyr')
library('dplyr')
library('DescTools')
library('vegan')
library('ggplot2')
library('lubridate')
library('ecotraj')

data <- read_csv('group2.csv')

# Identify top 3 species

species_abundance <- data |>
  group_by(species) |>
  summarise(total_abundance = sum(n, na.rm = T)) |>
  arrange(desc(total_abundance)) |>
  slice(1:10)

top3species <- species_abundance$species[1:3]

top3species

data$lambda = NA

# Plot top 3 species over time

data_over_time <- data |>
  filter(species %in% top3species) |>
  mutate(date = as.Date(date, format = "%m/%d/%Y"),
         year = year(date)) |> 
  group_by(species, year) |>
  summarise(N = sum(n, na.rm = T),
            avg_N = n(),
            .groups = "drop") |>
  arrange(species, year) |>
  ungroup()

ggplot(data_over_time, aes(x = year, y = N, color = species)) +
  geom_point() +
  geom_line() +
  labs(title = "Abundance of Top 3 Species Over Time",
       x = "Year",
       y = "Abundance",
       color = "Species") +
 
  theme_bw()
```

```{r}

# Density-independent model

data_w_lambda <- data_over_time |>
 arrange(species, year) |>
   mutate(lambda = lead(N)/N)

avg_lambda <- data_w_lambda |>
  group_by(species) |>
  summarise(
    mean_lambda = Gmean(lambda, na.rm = T),
    mean_sd = Gsd(lambda, na.rm = T)
  )

avg_lambda

# Plot lambda over time

ggplot(data_w_lambda |> filter(!is.na(lambda)),
       aes(x = year, y = lambda, color = species)) +
  geom_point() +
  geom_line() +
  labs(title = "Lambda Over Time", x = "Year", y = "Lambda", color = "Species") +
  theme_bw()

trends <- avg_lambda |>
  mutate(pop_trends = case_when(
    mean_lambda > 1.0 ~ "Growing",
    mean_lambda == 1.0 ~ "Satble",
    mean_lambda < 1.0 ~ "Declining"
  ))

trends


```

```{r}

# Project the population (density-independent model)

years <- 100

pop <- data_w_lambda |>
  group_by(species) |>
  slice_max(year, n = 1) |>
  select(species, N_0 = N, t_0 = year) |>
  left_join(avg_lambda, by = "species")

sim <- tibble()

for(i in 1:nrow(pop)) {
  Species <- pop$species[i]
  N0 <- pop$N_0[i]
  lambda <- pop$mean_lambda[i]
  t0 <- as.Date(pop$t_0[i])   
  
  N <- numeric(years + 1)
  N[1] <- N0
  
  for(t in 1:years) {
    N[t + 1] <- lambda * N[t]
  }
  
  projected_pop <- tibble(
    species = Species,
    year = 0:years,
    projection = N,
    t_i = t0 + years(0:years)  
  )
  
  sim <- bind_rows(sim, projected_pop)
}

sim

ggplot(sim, aes(x = year, y = projection, color = species)) +
  geom_line() +
  facet_wrap(~species, scales = "free_y") +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Abundance of Top 3 Species Using a\nDensity-Independent Population Model",
       x = "Years", y = "Projected Abundance", color = "Species") +
  theme_bw()
```

```{r}

# Estimate K for density-dependent model

pop2 <- data_w_lambda |>
  group_by(species) |>
  slice_max(year, n = 1) |>
  select(species, N_0 = N, t_0 = year) |>
  left_join(avg_lambda, by = "species") |>
  mutate(rd = mean_lambda - 1)

K_estimates <- tibble()

for(sp in top3species) {
  species_data <- data_over_time |>
    filter(species == sp) |>
    arrange(year) |>
    mutate(
      Nt = lead(N),
      change_in_N = (Nt - N) / N) |>
        filter(!is.na(change_in_N), is.finite(change_in_N))
      
      model <- lm(change_in_N ~ N, data = species_data)
      
      intercept <- coef(model)[1]
      
      slope <- coef(model)[2]
      
      if(slope < 0) {
        K_est <- -intercept / slope
        method <- "regression"
      } else {
        K_est <- max(species_data$N, na.rm = T) * 3
        method <- "max plus buffer"
      }
      
      K_estimates <- bind_rows(K_estimates,
                               tibble(species = sp,
                                      K = K_est,
                                      method = method))
}

# Project the population (density-dependent model)

pop2 <- pop2 |>
  left_join(K_estimates, by = "species")

pop2

sim2 <- tibble()

years <- 1000

for(i in 1:nrow(pop2)) {
  Species <- pop2$species[i]
  N0 <- pop2$N_0[i]
  rd <- pop2$rd[i]
  K <- pop2$K[i] 
  t0 <- pop2$t_0[i]   
  
  N <- numeric(years + 1)
  N[1] <- N0
  
  for(t in 1:years) {
    N[t + 1] <- N[t] + rd * N[t] * (1 - N[t] / K)
    
    if (N[t + 1] < 0) {
      N[t + 1] <- 0
    }
  }

  projected_pop2 <- tibble(
    species = Species,
    year = 0:years,
    projection = N,
    t_i = t0 + years(0:years),  
    K = K,
    rd = rd
  )
  
  sim2 <- bind_rows(sim2, projected_pop2)
}

sim2

ggplot(sim2, aes(x = year, y = projection, color = species)) +
  geom_line() +
  geom_hline(data = sim2 |> distinct(species, K),
             aes(yintercept = K, color = species),
             linetype = "dashed", linewidth = 1) +
  labs(title = "Abundance of Top 3 Species Using\na Density-Dependent Population Model",
    x = "Years",
    y = "Projected Abundance",
    color = "Species"
  ) +
    facet_wrap(~species, scales = "free_y", ncol = 1) +
  scale_y_continuous(labels = scales::comma) +
  theme_bw()

```

## 1.1b What can you infer from both models (Modeli \| Speciesi)? For each species, what is the most proper model to assess their growth? Why?

```{r}

# Summary table comparing both models

comparison_table <- pop2 |>
  select(species, N_0, rd, K, method) |>
  left_join(
    avg_lambda |> select(species, mean_lambda),
    by = "species"
  ) |>
  mutate(
    lambda_trend = case_when(
      mean_lambda > 1.0 ~ "Growing",
      mean_lambda < 1.0 ~ "Declining",
      TRUE ~ "Stable"
    ),
    density_dependent_trend = case_when(
      N_0 < K & rd > 0 ~ "Growing toward K",
      N_0 < K & rd < 0 ~ "Declining toward zero",
      N_0 > K ~ "Declining toward K",
      N_0 == K ~ "At equilibrium",
      TRUE ~ "Complex"
    )
  )

comparison_table
```

Density-independent models assume unlimited resources and constant lambda. Based on this model, Black Drum and Spotted Seatrout grew exponetially, while Gizzard Shad showed exponential decline.

The density-dependent model incorporates an estimate of carrying capacity (K), which represents resource limitations. Black Drum grew in a sigmoidal pattern, growing exponentially until nearing carrying capacity and reaching a stable state. Spotted Seatrout did the same, but it takes almost ten times as long to see that trend due to the smaller rd value. Gizzard Shad decrease to zero similarly to how they do with a density-independent model, but reaching zero takes much less time with the density-dependent model.

Because Black Drum and Spotted Seatrout reached their carrying capacitites, density-dependent effects are likely important, meaning a density-dependent model will work best to project the populations of these two species. Conversely, because Gizzard Shad decreased to zero (away from K) in both cases, a density-independent model works to assess the population growth of this species.

## 1.2 Based on the selected models, how does lambda change over time?

```{r}

# Density-independent lambda over time

sim_with_lambda <- sim |>
  arrange(species, year) |>
  group_by(species) |>
  mutate(
    lambda_realized = lead(projection) / projection
  ) |>
  ungroup()

ggplot(sim_with_lambda |> filter(!is.na(lambda_realized), year <= 100),
       aes(x = year, y = lambda_realized, color = species)) +
  geom_line(linewidth = 1) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
  facet_wrap(~species, scales = "free_y", ncol = 1) +
  labs(
    title = "Lambda Over Time, Density-Independent Model",
    x = "Years",
    y = "Lambda"
  ) +
  theme_bw()
  

# Density-dependent lambda over time

sim2_with_lambda <- sim2 |>
  arrange(species, year) |>
  group_by(species) |>
  mutate(
    lambda_realized = lead(projection) / projection
  ) |>
  ungroup()

ggplot(sim2_with_lambda |> filter(!is.na(lambda_realized), year <= 1000),
       aes(x = year, y = lambda_realized, color = species)) +
  geom_line(linewidth = 1) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
  facet_wrap(~species, scales = "free_y", ncol = 1) +
  labs(
    title = "Lambda Over Time, Density-Dependent Model",
    x = "Years",
    y = "Lambda"
  ) +
  theme_bw()
  
```

In a density-independent model, lambda is constant. However, in a density-dependent model, the trends in lambda decreased in a sigmoidal fashion towards 1 for Black Drum and Spotted Seatrout, while for Gizzard Shad, lambda started below one and decreased exponentially until leveling out.

## 1.3 Starting with the average abundance in 2000, perform a simulation (N = 100 replicates) of population growth using the growth variability based on the abundance values from start to 1999... How many times are the real abundance values intercepted by the uncertainty bounds of the simulation? Briefly discuss the performance of the models and potential reasons for the results.

```{r}

#Merging prep
df <- data 

df$date <- as.Date(df$date)
df$year <- format(df$date, "%Y") %>% as.numeric()
annual <- df %>%
  group_by(species, year) %>%
  summarise(total_n = sum(n), .groups = "drop")

#-----------------------------------------------------------
# Identify 10 most abundant species
#-----------------------------------------------------------
top10 <- annual %>%
  group_by(species) %>%
  summarise(total = sum(total_n)) %>%
  arrange(desc(total)) %>%
  slice_head(n = 10)

top10_species <- top10$species
top10_species

selected_species <- top10_species[1:3]
selected_species

#-----------------------------------------------------------
# Function to fit density-independent and density-dependent models
#-----------------------------------------------------------
fit_models <- function(df_sp) {
  
  df_sp <- df_sp %>% arrange(year)
  
  # Remove zeros to avoid log problems
  df_sp <- df_sp %>% filter(total_n > 0)
  
  # Compute growth rate
  df_sp <- df_sp %>%
    mutate(Nt = total_n,
           Nt1 = lead(Nt),
           lambda = Nt1 / Nt,
           logR = log(lambda))
  
  df_sp <- df_sp %>% filter(!is.na(logR))
  
  # Density-independent model (exponential)
  m1 <- lm(logR ~ 1, data = df_sp)
  
  # Density-dependent model (Ricker)
  m2 <- lm(logR ~ Nt, data = df_sp)
  
  out <- list(data = df_sp,
              m1 = m1,
              m2 = m2,
              AIC1 = AIC(m1),
              AIC2 = AIC(m2))
  
  return(out)
}

#-----------------------------------------------------------
#########################################
# 1.3 Simulation using λ variability
#########################################

simulate_growth <- function(sp, start_year = 2000, n_sims = 100) {
  
  # Species-specific time series
  df_sp <- annual %>% 
    filter(species == sp, total_n > 0) %>%
    arrange(year)
  
  # Early period: from beginning of the time series up to 1999
  df_early <- df_sp %>% filter(year < start_year)
  
  # Late period: 2000 onwards (what we want to project and compare)
  df_late  <- df_sp %>% filter(year >= start_year)
  
  # Need at least two years in early period to compute lambda
  if (nrow(df_early) < 2) {
    stop(paste("Not enough early data to compute lambda for species:", sp))
  }
  
  # Compute empirical lambda from early period (growth variability)
  df_early <- df_early %>%
    mutate(
      Nt  = total_n,
      Nt1 = lead(Nt),
      lambda = Nt1 / Nt
    ) %>%
    filter(!is.na(lambda))
  
  lambda_dist <- df_early$lambda
  
  if (length(lambda_dist) == 0) {
    stop(paste("No valid lambdas for early period for species:", sp))
  }
  
  # Starting value: average abundance in start_year (e.g., 2000)
  startN <- df_sp %>% 
    filter(year == start_year) %>%
    summarise(meanN = mean(total_n)) %>%
    pull()
  
  if (length(startN) == 0 || is.na(startN)) {
    stop(paste("No data for start year", start_year, "for species:", sp))
  }
  
  years_proj <- df_late$year
  n_years    <- length(years_proj)
  
  # Matrix of simulations: rows = years, cols = replicates
  N_mat <- matrix(NA_real_, nrow = n_years, ncol = n_sims)
  N_mat[1, ] <- startN
  
  # Project forward using random draws from the early λ distribution
  for (t in 2:n_years) {
    # draw a λ for each replicate at this time step
    lambdas_t <- sample(lambda_dist, n_sims, replace = TRUE)
    N_mat[t, ] <- N_mat[t - 1, ] * lambdas_t
  }
  
  # Convert to long format for CI calculation
  sim_df <- as.data.frame(N_mat)
  sim_df$year <- years_proj
  
  ci <- sim_df %>%
    pivot_longer(cols = -year, names_to = "sim", values_to = "N") %>%
    group_by(year) %>%
    summarise(
      low  = quantile(N, 0.025),
      high = quantile(N, 0.975),
      .groups = "drop"
    )
  
  # Compare with real observed abundance in late period
  compare <- df_late %>%
    left_join(ci, by = "year") %>%
    mutate(
      in_CI = total_n >= low & total_n <= high
    )
  
  list(
    sp      = sp,
    ci      = ci,
    compare = compare,
    df_late = df_late,
    sims    = sim_df
  )
}

# Run simulation for each selected species
sim_results <- selected_species %>% map(simulate_growth)

# Count interceptions (only years beyond 2000, not including 2000 itself)
for (res in sim_results) {
  cat("\n============================================\n")
  cat("Species:", res$sp, "\n")
  compare_post2000 <- res$compare %>% filter(year > 2000)
  inside <- sum(compare_post2000$in_CI, na.rm = TRUE)
  total  <- nrow(compare_post2000)
  cat("Real abundance inside 95% CI (years > 2000):", inside, "out of", total, "\n")
}


# Add this after running simulations:
for (res in sim_results) {
  
  p <- ggplot() +
    geom_ribbon(data = res$ci, 
                aes(x = year, ymin = low, ymax = high), 
                fill = "lightblue", alpha = 0.4) +
    geom_line(data = res$df_late, 
              aes(x = year, y = total_n), 
              color = "black", size = 1.2) +
    geom_point(data = res$compare, 
               aes(x = year, y = total_n, color = in_CI), 
               size = 3) +
    scale_color_manual(values = c("TRUE" = "darkgreen", "FALSE" = "red")) +
    theme_minimal() +
    labs(title = paste("Population Simulation 95% CI –", res$sp),
         y = "Abundance", x = "Year")
  
  print(p)
}

```
## For Black Drum and Spotted Seatrout, the stochastic model based on the pre-2000 λ distribution performed “well” in terms of statistical coverage: the observed abundance fell within the 95% simulation intervals in all post-2000 years (18/18). However, the prediction envelopes for these species became extremely wide and reached biologically unrealistic values (on the order of 10¹²–10¹⁴ individuals), while the observed abundances remained very low. This suggests that the empirically estimated λ distribution from 1980–1999 is highly variable and right-skewed, possibly driven by a few strong recruitment or catch events in the nekton monitoring data. When those rare, high λ values are repeatedly sampled in the simulations, the model produces explosive population growth that is not realized in the actual time series. It seems like the model has good nominal coverage but poor biological realism which may indicate that a simple density-independent stochastic model is not an adequate description of the underlying dynamics for these species.

##For Gizzard Shad, the model captured the observed data less well: only 11 out of 17 post-2000 years (~65%) fell within the 95% confidence interval, and the simulations tended to overestimate abundance after about 2005. This pattern implies a mismatch between the pre-2000 growth regime and the post-2000 dynamics. Possible explanations may be a real decline in Gizzard Shad abundance driven by changes in environmental conditions (e.g., flow, salinity, habitat quality) or increased mortality, shifts in spatial distribution among basins, or changes in catchability in the monthly trawl/gill-net surveys. All of these would violate the model’s assumption that the λ distribution from 1980–1999 is stationary through time.

##Our models were useful but using the historical λ distribution does a reasonable job of capturing interannual variability and uncertainty, but ignoring density dependence, environmental drivers, and changes in sampling or habitat across the Louisiana nekton monitoring program can lead to unrealistic projections and biased expectations of future abundance.


## 2.1 Does the sampling assigned to your group reach the asymptote of the species accumulation curve? Discuss results.

```{r}
Rare <- data |> 
  group_by(date) |> 
  ungroup()
sp_rare  <- unique(Rare$species)
yr_rare <- unique(data$date)
sp_rare_tib = tibble(n_samp = 1:length(yr_rare), n_spp = NA)
for (i in 1:length(yr_rare)){
  # sample ID to include
  samp = yr_rare[1:i]
  # include only sample numbers 
  d = data |> 
    filter(date %in% samp,
           n > 0)
  sp_rare_tib$n_spp[i] = length(unique(d$species))
}
ggplot(sp_rare_tib, aes(n_samp, n_spp))+
  geom_line(linewidth = 1)+
  labs(x = 'Number of Samples',
       y = 'Number of Species')+
  theme_bw()
```

(Answer)

## 2.2 Using the species that composed 75% of the abundance of species within the nektonic community, assess the annual trends of alpha and beta diversity, and the inverse Simpson diversity index.

```{r}
data2 <- data |>
  group_by(species) |>
  summarise(sum(n))
sum(data2$`sum(n)`)
16745*0.75
sp75 <- c('Black Drum', 'Red Drum', 'Atlantic Croaker', 'Blue Crab', 'Striped Mullet')
data <- data %>%
  mutate(date = mdy(date))
data <- data %>%
  mutate(year = year(date))
annual_abundance <- data %>%
  group_by(species, year) %>%
  summarise(total_abundance = sum(n, na.rm = TRUE), .groups = "drop")
annual_abundance <- annual_abundance |>
  filter(species %in% sp75)

df = unique(annual_abundance[c("year")])
df$H = NA
annual_abundance <- annual_abundance %>%
  rename(abundance = total_abundance)
for (i in 1:nrow(df)){
  d = annual_abundance |> filter(year == df$year[i])
  d = d |> 
    count(species,wt = abundance) |> 
    mutate(pi = n/sum(n),
           ln_pi = log(pi),
           p_ln_pi = pi*ln_pi)
  
  df$H[i] = -sum(d$p_ln_pi)
}
df |>
  summarise(mean_H = mean(H, na.rm = TRUE),
            sd_H = sd(H, na.rm = TRUE))
ggplot(df, aes(year, H)) +
  geom_line(linewidth = 1)+ 
  geom_point() +
  labs(x = 'Date',
       y = 'Shannon Diversity')+
  theme_bw()

df$d <- NA
for (i in 1:nrow(df)){
  d = annual_abundance |> filter(year == df$year[i])
  d = d |> count(species,wt = abundance) |> 
    mutate(pi = n/sum(n))
  
  df$d[i] = sum(d$pi^2)
}

df$even <- NA
df$inv <- NA
for(i in 1:nrow(df)){
df$even[i] = 1 - df$d[i]
df$inv[i] = 1/df$d[i]}

ggplot(df, aes(year, d)) +
  geom_line(linewidth = 1)+ 
  geom_point() +
  labs(x = 'Date',
       y = 'Simpson Diversity')+
  theme_bw()

ggplot(df, aes(year, inv)) +
  geom_line(linewidth = 1)+ 
  geom_point() +
  labs(x = 'Date',
       y = 'Inverse Simpson Diversity')+
  theme_bw()

mean(df$inv)

data_w <- data |>
  group_by(year, species) |>            
  summarise(total_n = sum(n), .groups="drop") |>
  pivot_wider(names_from = species, values_from = total_n, values_fill = 0)
comm <- data_w |> 
  summarise(across(`Black Drum`:`White Shrimp`, mean))

jacdist <- vegdist(data_w, method = "jaccard")
nmds.jc <- metaMDS(data_w, distance = "jaccard", k = 2, try = 100)
nmds.jc
braydist = vegdist(data_w, method = "bray")
braydist
nmds.bc = metaMDS(data_w, distance = "bray", k = 2, try = 100)
nmds_output = bind_rows(bc = data.frame(nmds.bc[["points"]]),
                        jc = data.frame(nmds.jc[["points"]])) |> 
  mutate(year = rep(unique(data_w$year), times = 2),
         Dissimilarity = rep(c("Bray", "Jaccard"),
                             each = length(unique(year))))

ggplot(nmds_output, aes(MDS1, MDS2, color = as.factor(year)))+
  geom_point(size = 4)+ 
  facet_wrap(~Dissimilarity)+
  labs(color = 'year')+
  scale_color_viridis_d(option = 'turbo')+
  theme_bw()
```

## 2.2 Using a community trajectory analysis, assess the annual stability of the fish community across the sites from the assigned basin and gear type. Describe and discuss the main results.

```{r}
data$site <- as.integer(factor(data$lat))
data_w2 <- data |>
  pivot_wider(names_from = species,
    values_from = n,
    values_fill = 0)
comm_matrix <- data_w2 |> select(-year, -basin, -date, -lat, -lon, -gear, -sci_name, -site)
site <- data$site
survey = data$year
b_dist <- vegdist(comm_matrix, method = "bray", na.rm = TRUE)
d <- defineTrajectories(b_dist, sites = site, surveys = survey)
trajectoryPCoA(d,
  traj.colors = c("black","red", "blue", 'lightblue3', 'purple', 'pink'),
  lwd = 3,
  survey.labels = FALSE)
legend("bottomleft", col=c("black","red", "blue", 'lightblue3', 'purple', 'pink'), 
       legend=unique(data$site), bty="n", lty=1, lwd = 2)
```

(Answer)

